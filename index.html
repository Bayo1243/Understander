<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNDERSTANDR</title>
    <link rel="icon" type="image/png" href="/logo-otak-digital.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #text-input::placeholder {
            color: #9ca3af;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-card {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        .conditional-input {
            transition: all 0.3s ease-in-out;
        }
        .main-container-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-100 via-rose-100 to-violet-200 min-h-screen">
    <div class="container mx-auto px-4 py-8 md:py-12 max-w-5xl">

        <!-- Header -->
        <header class="text-center mb-10">
            <div class="inline-block bg-rose-500 text-white p-3 rounded-xl mb-4 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            </div>
            <h1 class="text-4xl font-bold text-gray-800">UNDERSTANDR</h1>
            <p class="text-gray-600 mt-2">Helps understand your text</p>
        </header>

        <!-- Main Content -->
        <div class="bg-white/60 backdrop-blur-sm p-6 sm:p-8 rounded-2xl main-container-shadow border border-rose-200">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Text Input Area -->
                <div class="lg:col-span-2">
                    <label for="text-input" class="block text-lg font-semibold text-gray-800 mb-3">Paste your text here</label>
                    <textarea id="text-input" rows="18" class="w-full p-4 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-rose-500 transition duration-300 bg-white/60" placeholder="Enter the article, paragraph, or story you want to analyze..."></textarea>
                </div>

                <!-- Control Panel -->
                <div class="lg:col-span-1">
                     <h2 class="block text-lg font-semibold text-gray-800 mb-3">Choose an Analysis</h2>
                     <div class="flex flex-col space-y-4">
                        <select id="task-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500">
                            <option value="mainIdea">Find Main Idea</option>
                            <option value="summary">Summarize Text</option>
                            <option value="inference">Make an Inference</option>
                            <option value="tone">Find the Tone</option>
                            <option value="purpose">Find the Purpose</option>
                            <option value="genre">Identify the Genre</option>
                            <option value="wordMeaning">Explain a Word</option>
                            <option value="restateSentence">Restate a Sentence</option>
                        </select>

                        <div id="conditional-inputs-container" class="space-y-4">
                            <!-- Input for Word Meaning -->
                            <div id="word-input-container" class="hidden conditional-input">
                                <label for="word-input" class="block text-sm font-medium text-gray-600 mb-1">Word to explain:</label>
                                <input type="text" id="word-input" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., photosynthesis">
                            </div>
                            <!-- Input for Restate Sentence -->
                             <div id="sentence-input-container" class="hidden conditional-input">
                                <label for="sentence-input" class="block text-sm font-medium text-gray-600 mb-1">Sentence to restate:</label>
                                <textarea id="sentence-input" rows="3" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Copy and paste a sentence from the text..."></textarea>
                            </div>
                        </div>

                         <button id="analyze-btn" class="w-full bg-rose-500 text-white font-semibold py-3 px-5 rounded-lg hover:bg-rose-600 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:ring-offset-2 transition-transform duration-200 transform hover:scale-105 disabled:bg-rose-300 disabled:cursor-not-allowed">
                             Analyze Text
                         </button>
                     </div>
                </div>
            </div>
        </div>

        <!-- Results Area -->
        <main id="results-container" class="mt-8">
            <!-- Loading or error messages will appear here -->
            <!-- AI analysis results will be appended here -->
        </main>

    </div>

    <script>
        const textInput = document.getElementById('text-input');
        const resultsContainer = document.getElementById('results-container');
        const analyzeBtn = document.getElementById('analyze-btn');
        const taskSelect = document.getElementById('task-select');
        
        const wordInputContainer = document.getElementById('word-input-container');
        const wordInput = document.getElementById('word-input');
        const sentenceInputContainer = document.getElementById('sentence-input-container');
        const sentenceInput = document.getElementById('sentence-input');

        // State variables for inference cycling
        let inferenceList = [];
        let currentInferenceIndex = 0;
        let lastAnalyzedTextForInference = "";

        // --- Logic for weighted random restating ---
        const restateTypes = [
            { id: 'passiveVoice', name: 'Using Passive Voice', prompt: "You are an expert linguist. Your task is to paraphrase a given sentence in English **using only the passive voice**. First, provide the rewritten sentence in English. Then, in a new paragraph labeled '*Penjelasan:*', explain in Indonesian exactly how the subject and object were swapped to create the passive voice." },
            { id: 'indirectSpeech', name: 'As Indirect Speech', prompt: "You are an expert linguist. Your task is to paraphrase a given sentence in English **as if it were being reported (indirect speech)**. First, provide the rewritten sentence in English. Then, in a new paragraph labeled '*Penjelasan:*', explain in Indonesian how the sentence was changed to reported speech, mentioning changes in tense or pronouns if applicable." },
            { id: 'swappingSynonyms', name: 'Swapping Synonyms', prompt: "You are an expert linguist. Your task is to paraphrase a given sentence in English **by swapping key words with appropriate synonyms**. First, provide the rewritten sentence in English. Then, in a new paragraph labeled '*Penjelasan:*', list in Indonesian the original words and the synonyms you used to replace them. For example: 'mengubah X menjadi Y, dan A menjadi B'." },
            { id: 'changingStructure', name: 'Changing Structure', prompt: "You are an expert linguist. Your task is to paraphrase a given sentence in English **by significantly changing the clause order or overall sentence structure** while preserving the meaning. First, provide the rewritten sentence in English. Then, in a new paragraph labeled '*Penjelasan:*', describe in Indonesian how the sentence structure was altered, for example, by moving a subordinate clause to the beginning." }
        ];

        let restateUsageHistory = [];
        let restateTypeWeights = {};

        function initializeRestateWeights() {
            restateTypes.forEach(type => {
                restateTypeWeights[type.id] = 10; // Equal, high chance for all
            });
            restateUsageHistory = [];
             console.log("Weights reset:", restateTypeWeights);
        }

        function updateRestateWeights(usedTypeId) {
            // Add to history
            restateUsageHistory.push(usedTypeId);

            // Reset if all have been used
            if (restateUsageHistory.length >= restateTypes.length) {
                initializeRestateWeights();
                return;
            }

            // Update weights based on history
            const UNUSED_WEIGHT = 10;
            const BASE_USED_WEIGHT = 1;
            const historyReversed = [...restateUsageHistory].reverse();

            restateTypes.forEach(type => {
                const historyIndex = historyReversed.indexOf(type.id);
                if (historyIndex === -1) { // Unused
                    restateTypeWeights[type.id] = UNUSED_WEIGHT;
                } else { // Used
                    // Most recent (index 0) gets lowest weight, older ones get progressively higher
                    restateTypeWeights[type.id] = BASE_USED_WEIGHT + (2 * historyIndex);
                }
            });
            console.log("Weights updated:", restateTypeWeights, "History:", restateUsageHistory);
        }

        function selectRestateType() {
            const totalWeight = Object.values(restateTypeWeights).reduce((sum, weight) => sum + weight, 0);
            let random = Math.random() * totalWeight;

            for (const type of restateTypes) {
                random -= restateTypeWeights[type.id];
                if (random <= 0) {
                    return type;
                }
            }
            return restateTypes[0]; // Fallback
        }
        
        initializeRestateWeights(); // Initial setup
        // --- END of new logic ---

        const systemPrompts = {
            mainIdea: "You are an expert reading comprehension assistant. Your task is to identify and state the main idea of the provided text. First, state the main idea in a single, clear, and concise sentence. Then, in a new paragraph, provide a brief explanation for why this is the main idea, citing specific phrases or sentences from the text as evidence. Provide the explanation in Indonesian.",
            inference: "You are a highly skilled critical thinking expert. Your task is to identify what is **implied** but **not explicitly stated** in the text. An inference is a logical conclusion based on evidence and reasoning; it is not a direct translation or summary. For each distinct inference you find, you MUST follow this exact format:\n\n[Quote the relevant sentence or phrase from the original text here. Keep it in English and enclose it in quotation marks.]\n\n**Inference:**\n[State your logical conclusion—the implied meaning—here in Indonesian.]\n\n**Explanation:**\n[Explain in Indonesian how the provided quote logically leads to the inferred conclusion. Describe the reasoning that connects the explicit text to the hidden meaning.]\n\nSeparate each complete inference block with '|||'. Do not add any other text, numbering, or bullet points.",
            summary: "You are an expert reading comprehension assistant. Your task is to create a concise summary of the provided text. The summary should capture the key points and be no more than three sentences long.",
            tone: "You are an expert literary analyst. Your task is to identify the tone of the provided text. First, state the primary tone in one or two words (e.g., 'Formal and Objective', 'Nostalgic and Melancholy'). Then, in a new paragraph, provide a brief explanation with specific examples from the text to support your analysis. Provide the explanation in Indonesian.",
            purpose: "You are an expert rhetorical analyst. Your task is to determine the primary purpose of the provided text. State whether the purpose is to inform, persuade, entertain, or something else. Then, in a new paragraph, explain your reasoning using evidence from the text. Provide the explanation in Indonesian.",
            genre: "You are an expert in literary and textual genres. Your task is to identify the most likely genre of the provided text (e.g., 'News Report', 'Science Fiction Short Story', 'Personal Essay', 'Technical Manual'). In a new paragraph, briefly justify your choice based on the text's style, content, and structure. Provide the justification in Indonesian.",
            wordMeaning: "Anda adalah asisten pemahaman bacaan dan leksikografer ahli. Tugas Anda adalah menganalisis makna sebuah kata dalam konteks teks yang diberikan. Harap format jawaban Anda dengan rapi dan jelas, seluruhnya dalam Bahasa Indonesia, menggunakan struktur berikut:\n\n**Definisi:**\n[Tulis definisi sederhana dari kata yang ditanyakan di sini.]\n\n**Metode Penjelasan dalam Teks:**\n[Identifikasi metode yang digunakan dalam teks untuk menjelaskan kata tersebut. Pilih salah satu dari: Definisi Langsung, Contoh, Sinonim, atau Kontras.]\n\n**Kutipan dari Teks:**\n[Kutip kalimat atau frasa dari teks asli yang memberikan konteks untuk makna kata tersebut.]"
            // restateSentence is now handled by the new logic
        };

        const resultTitles = {
            mainIdea: "Main Idea",
            summary: "Summary",
            tone: "Author's Tone",
            purpose: "Author's Purpose",
            genre: "Text Genre",
            wordMeaning: "Word Meaning Analysis"
            // restateSentence title is now dynamic
        };
        
        taskSelect.addEventListener('change', () => {
            const selectedTask = taskSelect.value;
            wordInputContainer.classList.toggle('hidden', selectedTask !== 'wordMeaning');
            sentenceInputContainer.classList.toggle('hidden', selectedTask !== 'restateSentence');
        });

        function setLoading(isLoading) {
            analyzeBtn.disabled = isLoading;
            if (isLoading) {
                resultsContainer.innerHTML = `
                    <div id="loading-indicator" class="text-center p-6 bg-white rounded-xl shadow-md border">
                        <div class="flex justify-center items-center space-x-2">
                            <div class="w-2 h-2 bg-rose-500 rounded-full animate-pulse" style="animation-delay: -0.3s;"></div>
                            <div class="w-2 h-2 bg-rose-500 rounded-full animate-pulse" style="animation-delay: -0.15s;"></div>
                            <div class="w-2 h-2 bg-rose-500 rounded-full animate-pulse"></div>
                        </div>
                        <p class="mt-3 text-gray-600 text-sm">Analyzing text...</p>
                    </div>
                `;
            } else {
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) loadingIndicator.remove();
            }
        }
        
        function displayResult(title, content) {
            resultsContainer.innerHTML = '';
            const card = document.createElement('div');
            card.className = 'result-card bg-white p-6 rounded-2xl shadow-lg border border-gray-200';
            let formattedContent = content.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
            formattedContent = formattedContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formattedContent = formattedContent.replace(/\*(.*?)\*/g, '<em>$1</em>');
            card.innerHTML = `
                <h2 class="text-2xl font-bold text-rose-700 mb-4">${title}</h2>
                <div class="text-gray-700 leading-relaxed space-y-4">${formattedContent}</div>
            `;
            resultsContainer.appendChild(card);
        }
        
        function displayError(message) {
            resultsContainer.innerHTML = `
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert">
                    <p class="font-bold">An error occurred</p>
                    <p>${message}</p>
                </div>
            `;
        }

        async function getAIAnalysis(text, task, additionalInput = "") {
            setLoading(true);

            const apiKey = "AIzaSyCFx0aN9Z7UaZDbH1WxaT2ILQBSGO3uIAw";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            let systemPrompt, userPrompt = text, resultTitle;
            
            if (task === 'restateSentence') {
                const selectedType = selectRestateType();
                systemPrompt = selectedType.prompt;
                userPrompt = `TEXT: """${text}"""\n\nSENTENCE TO RESTATE: "${additionalInput}"`;
                resultTitle = `Restated Sentence (${selectedType.name})`;
                updateRestateWeights(selectedType.id); // Update weights after selection
            } else {
                 systemPrompt = systemPrompts[task];
                 resultTitle = resultTitles[task];
                if (task === 'wordMeaning' && additionalInput) {
                    userPrompt = `TEXT: """${text}"""\n\nWORD TO ANALYZE: "${additionalInput}"`;
                }
            }

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    temperature: 0.0,
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText} (Status: ${response.status})`);
                }
                
                const result = await response.json();
                const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiText) {
                    if (task === 'inference') {
                        inferenceList = aiText.split('|||').map(item => item.trim()).filter(item => item !== '');
                        lastAnalyzedTextForInference = text;
                        if (inferenceList.length > 0) {
                            currentInferenceIndex = 0;
                            const title = `Inference (${currentInferenceIndex + 1} of ${inferenceList.length})`;
                            displayResult(title, inferenceList[currentInferenceIndex]);
                        } else {
                            displayResult("Inference", "The AI could not find any clear inferences in the provided text.");
                        }
                    } else {
                        displayResult(resultTitle, aiText);
                    }
                } else {
                    throw new Error("The AI returned an empty or invalid response.");
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                displayError("I seem to be having trouble analyzing the text. Please try again in a moment.");
            } finally {
                setLoading(false);
            }
        }

        analyzeBtn.addEventListener('click', () => {
            const task = taskSelect.value;
            const text = textInput.value.trim();
            
            if (!text) {
                displayError("Please paste some text into the box before choosing an analysis.");
                return;
            }
            
            // Handle inference cycling
            if (task === 'inference' && text === lastAnalyzedTextForInference && inferenceList.length > 0) {
                currentInferenceIndex = (currentInferenceIndex + 1) % inferenceList.length;
                const title = `Inference (${currentInferenceIndex + 1} of ${inferenceList.length})`;
                displayResult(title, inferenceList[currentInferenceIndex]);
                return; // Skip new API call
            }

            // Reset inference state if task changes or text changes
            if (task !== 'inference' || text !== lastAnalyzedTextForInference) {
                inferenceList = [];
                currentInferenceIndex = 0;
            }

            let additionalInput = "";
            if (task === 'wordMeaning') {
                additionalInput = wordInput.value.trim();
                if (!additionalInput) {
                    displayError("Please enter a word to explain.");
                    return;
                }
            } else if (task === 'restateSentence') {
                additionalInput = sentenceInput.value.trim();
                 if (!additionalInput) {
                    displayError("Please enter a sentence to restate.");
                    return;
                }
            }
            
            getAIAnalysis(text, task, additionalInput);
        });
    </script>
</body>
</html>

